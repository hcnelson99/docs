\begin{appendix}

\chapter{$\opercalc$ Proofs}

\begin{lemma}[Canonical Forms]
Unless the rule used is \textsc{$\varepsilon$-Subsume}, the following are true:
\begin{enumerate}
	\setlength\itemsep{-0.7em}
	\item If $ \Gamma \vdash  v:  \tau~\kw{with} \varepsilon$ then $\varepsilon = \varnothing$.
	\item If $ \Gamma \vdash v: \{ \bar r \}~\kw{with} \varepsilon$ then $ v = r$ for some $r \in R$ and $\{ \bar r \} = \{ r \}$.
	\item If $\Gamma \vdash v: \tau_1 \rightarrow_{\varepsilon'} \tau_2~\kw{with} \varepsilon$ then $v = \lambda x:\tau. e$.
\end{enumerate}
\end{lemma}

\begin{proof}
~
\begin{enumerate}
	\setlength\itemsep{-0.7em}
	\item A value is either a resource literal or a lambda. The only rules which can type values are \textsc{$\varepsilon$-Resource} and \textsc{$\varepsilon$-Abs}. In the conclusions of both, $\varepsilon = \varnothing$.
	\item The only rule ascribing the type $\{ \bar r \}$ is \textsc{$\varepsilon$-Resource}. Its premises imply the result.
	\item The only rule ascribing the type $\tau_1 \rightarrow_{\varepsilon'} \tau_2$ is \textsc{$\varepsilon$-Abs}. Its premises imply the result.
\end{enumerate}
\end{proof}

\hrulefill


\begin{theorem}[Progress]
If $ \Gamma \vdash  e:  \tau~\kw{with} \varepsilon$ and $ e$ is not a value or variable, then $ e \longrightarrow  e'~|~\varepsilon$.
\end{theorem}

\begin{proof} By induction on $ \Gamma \vdash  e:  \tau~\kw{with} \varepsilon$. \\

Case: \textsc{$\varepsilon$-Var}, \textsc{$\varepsilon$-Resource}, or  \textsc{$\varepsilon$-Abs}. Then $e$ is a value or variable, and the theorem statement holds vacuously.\\

Case: \textsc{$\varepsilon$-App}. Then $ e =  e_1~ e_2$. If $ e_1$ is a non-value it can be reduced by inductive assumption, and then $ e_1~ e_2 \longrightarrow  e_1'~ e_2$ by \textsc{E-App1}. If $ e_1 =  v_1$ is a value and $ e_2$ a non-value, then $e_2$ can be reduced by inductive assumption and then $ e_1~ e_2 \longrightarrow  v_1~ e_2'$ by \textsc{E-App2}. Otherwise $ e_1 = v_1$ and $ e_2 = v_2$ are both values. By canonical forms, $v_1 = \lambda x: \tau. e$. Then $(\lambda x:  \tau.  e)  v_2 \longrightarrow [ v_2/x]~|~\varnothing$ by \textsc{E-App3}.\\

Case: \textsc{$\varepsilon$-Oper}. Then $ e =  e_1.\pi$. If $ e_1$ is a non-value it can be reduced by inductive assumption, and then $ e_1.\pi \longrightarrow  e_1'.\pi~|~\varepsilon_1$ by \textsc{E-OperCall1}. Otherwise $ e_1 =  v_1$ is a value. By canonical forms, $ v_1 = r$. Then $r.\pi \longrightarrow \kwa{unit}~|~\{ r.\pi \}$ by \textsc{E-OperCall2}.\\

Case: \textsc{$\varepsilon$-Subsume}. Then $ \Gamma \vdash  e:  \tau'~\kw{with} \varepsilon'$. By inversion, $ \Gamma \vdash  e: \tau~\kw{with} \varepsilon$, where $\tau' <: \tau$ and $\varepsilon' \subseteq \varepsilon$. If $e$ is a value or variable, the theorem holds vacuously. Otherwise the reduction exists by applying the inductive assumption to the sub-derivation.
\end{proof}

\hrulefill

\begin{lemma}[Substitution]
If $\Gamma, x: \tau' \vdash e: \tau~\kw{with} \varepsilon$ and $ \Gamma \vdash  v: \tau'~\kw{with} \varnothing$ then $ \Gamma \vdash [ v/x]e:  \tau~\kw{with} \varepsilon$.
\end{lemma}

\begin{proof} By induction on $ \Gamma, x:  \tau' \vdash e:  \tau~\kw{with} \varepsilon$. \\

\textit{Case}: \textsc{$\varepsilon$-Var}. Then $ e = y$ and either $y = x$ or $y \neq x$.

\textbf{Subcase 1:} $y \neq x$. By theorem assumption, $\Gamma \vdash y:\tau~\kw{with} \varepsilon$, where $\varepsilon = \varnothing$ by inversion on \textsc{$\varepsilon$-Var}. Since $[v/x]y = y$, then $ \Gamma \vdash [ v/x]y:  \tau~\kw{with} \varnothing$.

\textbf{Subcase 2:} $y = x$. By inversion on \textsc{$\varepsilon$-Var}, the typing judgement from the theorem assumption is $ \Gamma, x:  \tau' \vdash x:  \tau'~\kw{with} \varnothing$. Since $[ v/x]y =  v$, and by assumption $ \Gamma \vdash  v:  \tau'~\kw{with} \varnothing$, then $ \Gamma \vdash [ v/x]x:  \tau'~\kw{with} \varnothing$. \\

\textit{Case}: \textsc{$\varepsilon$-Resource}. Because $ e = r$ is a resource literal then $ \Gamma \vdash r:  \{ r \}~\kw{with} \varnothing$ by canonical forms. By definition $[ v/x]r = r$, so $ \Gamma \vdash [ v/x]r:  \{ \bar r\}~\kw{with} \varnothing$. \\

\textit{Case:} \textsc{$\varepsilon$-App}. By inversion, $ \Gamma, x:  \tau' \vdash  e_1: \tau_2 \rightarrow_{\varepsilon_3}  \tau_3~\kw{with} \varepsilon_A$ and $ \Gamma, x:  \tau' \vdash  e_2:  \tau_2~\kw{with} \varepsilon_B$, where $\varepsilon = \varepsilon_A \cup \varepsilon_B \cup \varepsilon_3$ and $ \tau =  \tau_3$. By inductive assumption, $ \Gamma \vdash [ v/x] e_1:  \tau_2 \rightarrow_{\varepsilon_3}  \tau_3~\kw{with} \varepsilon_A$ and $ \Gamma \vdash [ v/x] e_2:  \tau_2~\kw{with} \varepsilon_B$. By \textsc{$\varepsilon$-App} we have $ \Gamma \vdash ([ v/x] e_1) ([ v/x] e_2) :  \tau_3~\kw{with} \varepsilon_A \cup \varepsilon_B \cup \varepsilon_3$. By simplifying and applying the definition of $\kwa{substitution}$, this is the same as $ \Gamma \vdash [ v/x]( e_1  e_2):  \tau~\kw{with} \varepsilon$. \\

\textit{Case:} \textsc{$\varepsilon$-OperCall}. By inversion, $ \Gamma, x:  \tau' \vdash  e_1: \{ \bar r \}~\kw{with} \varepsilon_1$, where $ \tau = \{ \bar r \}$ and $\varepsilon = \varepsilon_1 \cup \{ r.\pi \mid r \in \bar r, \pi \in \Pi \}$. By applying the inductive assumption, $ \Gamma \vdash [ v/x] e_1 : \{ \bar r \} ~\kw{with} \varepsilon_1$. Then by \textsc{$\varepsilon$-OperCall}, $ \Gamma \vdash ([ v/x] e_1).\pi: \{ \bar r \}~\kw{with} \varepsilon_1 \cup \{ r.\pi \mid r.\pi \in \bar r \times \Pi \}$. By simplifying and applying the definition of $\kwa{substitution}$, this is the same as $ \Gamma \vdash [ v/x]( e_1.\pi):  \tau~\kw{with} \varepsilon$.\\

\textit{Case:} \textsc{$\varepsilon$-Subsume}. By inversion, $ \Gamma, x:  \tau' \vdash  e:  \tau_2~\kw{with} \varepsilon_2$, where $ \tau_2 <:  \tau$ and $\varepsilon_2 \subseteq \varepsilon$. By inductive hypothesis, $ \Gamma \vdash [ v/x] e:  \tau_2~\kw{with} \varepsilon_2$. Then $ \Gamma \vdash [ v/x] e:  \tau~\kw{with} \varepsilon$ by \textsc{$\varepsilon$-Subsume}.

\end{proof}


\hrulefill

\begin{theorem}[Preservation]
If $ \Gamma \vdash  e_A:  \tau_A~\kw{with} \varepsilon_A$ and $e_A \longrightarrow e_B~|~\varepsilon_C$, then $ \Gamma \vdash e_B: \tau_B~\kw{with} \varepsilon_B$, where $e_B <: e_A$ and $\varepsilon \cup \varepsilon_B \subseteq \varepsilon_A$.
\end{theorem}

\begin{proof}
By induction on $ \Gamma \vdash  e_A:  \tau_A~\kw{with} \varepsilon_A$, and then on $e_A \longrightarrow e_B~|~\varepsilon$. \\

\textit{Case:} \textsc{$\varepsilon$-Var}, \textsc{$\varepsilon$-Resource}, \textsc{$\varepsilon$-Unit}, \textsc{$\varepsilon$-Abs}. Then $e_A$ is a value and cannot be reduced, so the theorem holds vacuously. \\

\textit{Case:} \textsc{$\varepsilon$-App}. Then $e_A =  e_1~ e_2$ and $ e_1:  \tau_2 \longrightarrow_{\varepsilon}  \tau_3~\kw{with} \varepsilon_1$ and $ \Gamma \vdash  e_2:  \tau_2~\kw{with} \varepsilon_2$ and $\tau_B = \tau_3$ and $\varepsilon_A = \varepsilon_1 \cup \varepsilon_2 \cup \varepsilon$.

\textbf{Subcase:} \textsc{E-App1}. Then $e_1~e_2 \longrightarrow e_1'~e_2~|~\varepsilon_C$. From inversion on \textsc{E-App1}, $e_1 \longrightarrow e_1'~|~\varepsilon_C$. By inductive hypothesis and application of \textsc{$\varepsilon$-Subsume}, $\Gamma \vdash e_1': \tau_2 \longrightarrow_{\varepsilon} \tau_3~\kw{with} \varepsilon_1$. Then $\Gamma \vdash e_1'~e_2: \tau_3~\kw{with} \varepsilon_1 \cup \varepsilon_2 \cup \varepsilon$ by \textsc{$\varepsilon$-App}.

\textbf{Subcase:} \textsc{E-App2}. Then $e_1 = v_1$ is a value and $e_2 \longrightarrow e_2'~|~\varepsilon_C$. By inversion on \textsc{E-App2}, $e_2 \longrightarrow e_2'~|~\varepsilon_C$. By inductive hypothesis and application of \textsc{$\varepsilon$-Subsume}, $\Gamma \vdash e_2': \tau_2~\kw{with} \varepsilon_2$. Then $\Gamma \vdash v_1~e_2': \tau_3~\kw{with} \varepsilon_1 \cup \varepsilon_2 \cup \varepsilon$ by \textsc{$\varepsilon$-App}.

\textbf{Subcase:} \textsc{E-App3}. Then $e_1 = \lambda x: \tau_2.e$ and $e_2 = v_2$ are values, and $(\lambda x: \tau_2.e)~v_2 \longrightarrow [v_2/x]e~|~\varnothing$. By inversion on the typing rule for $\lambda x:  \tau_2. e$, we know $\Gamma, x:  \tau_2 \vdash e: \tau_3~\kw{with} \varepsilon_3$. By canonical forms, $\varepsilon_2 = \varnothing$ because $ e_2 =  v_2$ is a value. Then by the substitution lemma, $ \Gamma \vdash [ v_2/x] e :  \tau_3~\kw{with} \varepsilon_3$. By canonical forms, $\varepsilon_1 = \varepsilon_2 = \varnothing = \varepsilon_C$. Therefore $\varepsilon_A = \varepsilon_3 = \varepsilon_B \cup \varepsilon_C$. \\

\textit{Case:}  \textsc{$\varepsilon$-OperCall}. Then $e_A = e_1.\pi$ and $e_1: \{ \bar r \}~\kw{with} \varepsilon_1$ and $\tau_A = \Unit$ and $\varepsilon_A = \varepsilon_1 \cup \{ r.\pi \mid r \in \bar r, \pi \in \Pi \}$.

\textbf{Subcase:} \textsc{E-OperCall1}. Then $e_1.\pi \longrightarrow e_1'.\pi~|~\varepsilon_C$. By inversion on \textsc{E-OperCall1}, $e_1 \longrightarrow e_1'~|~\varepsilon_C$. By inductive hypothesis and application of \textsc{$\varepsilon$-Subsume}, $\Gamma \vdash e_1: \{ \bar r \}~\kw{with} \varepsilon_1$. Then $\Gamma \vdash e_1'.\pi: \{ \bar r \}~\kw{with} \varepsilon_1 \cup \{ r.\pi \mid r \in \bar r, \pi \in \Pi \}$.


\textbf{Subcase:} \textsc{E-OperCall2}. Then $e_1 = r$ is a resource literal and $r.\pi \longrightarrow \kwa{unit}~|~\{ r.\pi \}$. By canonical forms, $ \Gamma \vdash r: \kwa{unit}~\kw{with} \{ r.\pi \}$. Trivially, $ \Gamma \vdash \kwa{unit}: \kwa{Unit}~\kw{with} \varnothing$. Therefore $\tau_B = \tau_A$ and $\varepsilon_C \cup \varepsilon_B = \{ r.\pi \} = \varepsilon_A$.
\end{proof}

\hrulefill

\begin{theorem}[Soundness]
If $ \Gamma \vdash  e_A:  \tau_A~\kw{with} \varepsilon_A$ and $ e_A$ is not a value, then $e_A \longrightarrow e_B~|~\varepsilon$, where $ \Gamma \vdash e_B:  \tau_B~\kw{with} \varepsilon_B$ and $ \tau_B <:  \tau_A$ and $\varepsilon_B \cup \varepsilon \subseteq \varepsilon_A$.
\end{theorem}
\begin{proof}
If $ e_A$ is not a value or variable then the reduction exists by the progress theorem. The rest of the theorem statement follows by the preservation theorem.
\end{proof}

\hrulefill

\begin{theorem}[Multi-step Soundness]
If $ \Gamma \vdash  e_A:  \tau_A~\kw{with} \varepsilon_A$ and $e_A \longrightarrow^{*} e_B~|~\varepsilon$, where $ \Gamma \vdash e_B:  \tau_B~\kw{with} \varepsilon_B$ and $ \tau_B <:  \tau_A$ and $\varepsilon_B \cup \varepsilon \subseteq \varepsilon_A$.
\end{theorem}

\begin{proof} By induction on the length of the multi-step reduction.\\

\textit{Case:} Length $0$. Then $e_A = e_B$, and therefore $\tau_A = \tau_B$ and $\varepsilon = \varnothing$ and $\varepsilon_A = \varepsilon_B$.\\

\textit{Case:} Length $1$. Then the result follows by single-step soundness.\\

\textit{Case:} Length $n+1$. Then by inversion the multi-step can be split into a multi-step of length $n$, which is $ e_A \longrightarrow^{*}  e_C~|~\varepsilon'$, and a single-step of length $1$, which is $e_C \longrightarrow e_B~|~\varepsilon''$, where $\varepsilon = \varepsilon' \cup \varepsilon''$. By inductive assumption and preservation theorem, $ \Gamma \vdash  e_C:  \tau_C~\kw{with} \varepsilon_C$ and $ \Gamma \vdash  e_B:  \tau_B~\kw{with} \varepsilon_B$. By inductive assumption, $ \tau_C <:  \tau_A$ and $ \varepsilon_C \cup \varepsilon' \subseteq \varepsilon_A$. By single-step soundness, $ \tau_B <:  \tau_C$ and $ \varepsilon_B \cup \varepsilon'' \subseteq \varepsilon_C$. Then by transitivity, $ \tau_B <:  \tau$ and $ \varepsilon_B \cup \varepsilon' \cup \varepsilon'' = \varepsilon_B \cup \varepsilon \subseteq \varepsilon_A$.
\end{proof}















\chapter{$\epscalc$ Proofs}\label{appendix:LAS File}

\begin{theorem}[Progress]
If $\hat \Gamma \vdash \hat e_A: \hat \tau~\kw{with} \varepsilon$ and $\hat e_A$ is not a value or variable, then $\hat e_A \longrightarrow \hat e_B~|~\varepsilon$.
\end{theorem}

\begin{proof} By induction on $\hat \Gamma \vdash \hat e: \hat \tau~\kw{with} \varepsilon$.\\

Case: \textsc{$\varepsilon$-Module}. Then $\hat e_A = \import{\varepsilon}{x}{\hat e}{e}$. If $\hat e$ is a non-value then $\hat e \longrightarrow \hat e'~|~\varepsilon'$ by inductive assumption. Then $\import{\varepsilon}{x}{\hat e}{e} \longrightarrow \import{\varepsilon}{x}{\hat e'}{e}~|~\varepsilon'$ by \textsc{E-Module1}. Otherwise $\hat e = \hat v$ is a value. Then $\import{\varepsilon}{x}{\hat v}{e} \longrightarrow [\hat v/x]\kwa{annot}(e, \varepsilon)~|~\varnothing$ by \textsc{E-Module2}.
\end{proof}


\hrulefill

\begin{lemma}[Substitution]
If $\hat \Gamma, x: \hat \tau' \vdash \hat e_A: \hat \tau_A~\kw{with} \varepsilon_A$ and $\hat \Gamma \vdash \hat v: \hat \tau'~\kw{with} \varnothing$ then $\hat \Gamma \vdash [\hat v/x]e: \hat \tau_A~\kw{with} \varepsilon_A$.
\end{lemma}

\begin{proof} By induction on $\hat \Gamma, x: \hat \tau' \vdash \hat e_A: \hat \tau_A~\kw{with} \varepsilon_A$. \\

\textit{Case:} \textsc{$\varepsilon$-Module}. Then the following are true.

\begin{enumerate}
	\setlength\itemsep{-0.7em}
	\item $\hat \Gamma, x: \hat \tau' \vdash \import{\varepsilon}{x}{\hat e}{e} : \kwa{annot}(\tau, \varepsilon)~\kw{with} \varepsilon \cup \varepsilon_1$
	\item $\hat \Gamma, x: \hat \tau' \vdash \hat e: \hat \tau~\kw{with} \varepsilon_1$
	\item $\varepsilon = \fx{\hat \tau} \cup \hofx{\annot{\tau}{\varepsilon}}$
	\item $x: \erase{\hat \tau} \vdash e: \tau$
	\item $\hat \tau_A = \annot{\tau}{\varepsilon}$
	\item $\hat \varepsilon_A = \varepsilon \cup \varepsilon_1$
\end{enumerate}

By applying inductive assumption to (2), $\hat \Gamma \vdash [\hat v/x]\hat e: \hat \tau~\kw{with} \varepsilon_1$.
 Then by \textsc{$\varepsilon$-Module}, $\hat \Gamma \vdash \import{\varepsilon}{x}{[\hat v/x]\hat e}{e}: \kwa{annot}(\tau, \varepsilon)~\kw{with} \varepsilon \cup \varepsilon_1$.
\end{proof}

\hrulefill

\begin{lemma}
If $\kwa{effects}(\hat \tau) \subseteq \varepsilon$ and $\kwa{ho \hyphen safe}(\hat \tau, \varepsilon)$ then $\hat \tau <: \kwa{annot}(\kwa{erase}(\hat \tau), \varepsilon)$.
\end{lemma}

\begin{lemma}
If $\kwa{ho \hyphen effects}(\hat \tau) \subseteq \varepsilon$ and $\safe{\hat \tau}{\varepsilon}$ then $\kwa{annot(erase}(\hat \tau), \varepsilon) <: \hat \tau$.
\end{lemma}

\begin{proof}
By simultaneous induction on derivations of $\kwa{safe}$ and $\kwa{ho \hyphen safe}$.\\

\textit{Case:} $\hat \tau = \{ \bar r \}$ Then $\hat \tau = \kwa{annot(erase}(\hat \tau), \varepsilon)$ and the results for both lemmas hold immediately. \\

\textit{Case: $\hat \tau = \hat \tau_1 \rightarrow_{\varepsilon'} \hat \tau_2$, $\fx{\hat \tau} \subseteq \varepsilon$, $\hosafe{\hat \tau}{\varepsilon}$} It is sufficient to show $\hat \tau_2 <: \kwa{annot(erase}(\hat \tau_2), \varepsilon)$ and $\kwa{annot(erase}(\hat \tau_1), \varepsilon) <: \hat \tau_1$, because the result will hold by \textsc{S-Effects}. To achieve this we shall inductively apply \textbf{lemma 2} to $\hat \tau_2$ and \textbf{lemma 3} to $\hat \tau_1$. 

From $\fx{\hat \tau} \subseteq \varepsilon$ we have $\hofx{\hat \tau_1} \cup \varepsilon' \cup \fx{\hat \tau_2} \subseteq \varepsilon$ and therefore $\fx{\hat \tau_2} \subseteq \varepsilon$. From $\hosafe{\hat \tau}{\varepsilon}$ we have $\hosafe{\hat \tau_2}{\varepsilon}$. Therefore we can apply \textbf{lemma 2} to $\hat \tau_2$.

From $\fx{\hat \tau} \subseteq \varepsilon$ we have $\hofx{\hat \tau_1} \cup \varepsilon' \cup \fx{\hat \tau_2} \subseteq \varepsilon$ and therefore $\hofx{\hat \tau_1} \subseteq \varepsilon$. From $\hosafe{\hat \tau}{\varepsilon}$ we have $\hosafe{\hat \tau_1}{\varepsilon}$. Therefore we can apply \textbf{lemma 3} to $\hat \tau_1$.\\

\textit{Case: $\hat \tau = \hat \tau_1 \rightarrow_{\varepsilon'} \hat \tau_2$, $\hofx{\hat \tau} \subseteq \varepsilon$, $\safe{\hat \tau}{\varepsilon}$ } It is sufficient to show $\kwa{annot(erase}(\hat \tau_2), \varepsilon) <: \hat \tau_2$ and $\hat \tau_1 <: \kwa{annot(erase}(\hat \tau_1), \varepsilon)$, because the result will hold by \textsc{S-Effects}. To achieve this we shall inductively apply \textbf{lemma 3} to $\hat \tau_2$ and \textbf{lemma 2} to $\hat \tau_1$.

From $\hofx{\hat \tau} \subseteq \varepsilon$ we have $\fx{\hat \tau_1} \cup \hofx{\hat \tau_2} \subseteq \varepsilon$ and therefore $\hofx{\hat \tau_2} \subseteq \varepsilon$. From $\safe{\hat \tau}{\varepsilon}$ we have $\safe{\hat \tau_2}{\varepsilon}$. Therefore we can apply \textbf{lemma 3} to $\hat \tau_2$.

From $\hofx{\hat \tau} \subseteq \varepsilon$ we have $\fx{\hat \tau_1} \cup \hofx{\hat \tau_2} \subseteq \varepsilon$ and therefore $\fx{\hat \tau_1} \subseteq \varepsilon$. From $\safe{\hat \tau}{\varepsilon}$ we have $\hosafe{\hat \tau_1}{\varepsilon}$. Therefore we can apply \textbf{lemma 2} to $\hat \tau_1$.

\end{proof}


\hrulefill

\begin{lemma}[Annotation]
If the following are true:

\begin{enumerate}
	\setlength\itemsep{-0.7em}
	\item $\hat \Gamma \vdash \hat v : \hat \tau~\kw{with} \varnothing$
	\item $\Gamma, y: \kwa{erase}(\hat \tau) \vdash e: \tau$
	\item $\varepsilon = \kwa{effects}(\hat \tau) \cup \hofx{\annot{\tau}{\varepsilon}}$
	\item $\kwa{ho \hyphen safe}(\hat \tau, \varepsilon)$
\end{enumerate}

\noindent
Let $\varepsilon' = \varepsilon~\cup~ \fx{\annot{\Gamma}{\varepsilon}}$. Then $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon'), y: \hat \tau \vdash \kwa{annot}(e, \varepsilon') : \kwa{annot}(\tau, \varepsilon')~\kw{with} \varepsilon'$.
\end{lemma}

\begin{proof}
By induction on $\Gamma, y: \kwa{erase}(\hat \tau) \vdash e: \tau$.\\

\textit{Case: \textsc{T-Var}}. Then $e=x$ and $\Gamma, y: \kwa{erase}(\hat \tau) \vdash x: \tau$. Either $x=y$ or $x \neq y$. \\

\textbf{Subcase 1: $x = y$}. Then by assumption, $y: \erase{\hat \tau} \vdash x: \tau$, so $\tau = \erase{\hat \tau}$. By \textsc{$\varepsilon$-Var}, $y: \hat \tau \vdash x: \hat \tau~\kw{with} \varnothing$. By definition, $\annot{x}{\varepsilon'} = x$, so $y: \hat \tau \vdash \annot{x}{\varepsilon'}: \hat \tau~\kw{with} \varnothing$. By assumptions (3) and (4) we know $\fx{\hat \tau} \subseteq \varepsilon$ and $\hosafe{\hat \tau}{\varepsilon}$, so applying \textbf{Lemma 2} gives $\hat \tau <: \annot{\erase{\hat \tau}}{\varepsilon}$. Then applying \textsc{$\varepsilon$-Subsume} to the type of $y: \hat \tau \vdash \annot{x}{\varepsilon}: \hat \tau~\kw{with} \varnothing$ gives $y: \hat \tau \vdash \annot{x}{\varepsilon}: \annot{\erase{\hat \tau}}{\varepsilon}~\kw{with} \varnothing$. We already know $\erase{\hat \tau} = \tau$, so this judgement is the same as $y: \hat \tau \vdash \annot{x}{\varepsilon}: \annot{\tau}{\varepsilon}~\kw{with} \varnothing$. By applying \textsc{$\varepsilon$-Subsume} to $\varnothing$ we get $y: \hat \tau \vdash \annot{x}{\varepsilon}: \annot{\tau}{\varepsilon}~\kw{with} \varepsilon \cup \kwa{effects}(\kwa{annot}(\Gamma, \varepsilon))$. Lastly, by widening the context, we have $\hat \Gamma, \annot{\Gamma}{\varepsilon}, y: \hat \tau \vdash \annot{x}{\varepsilon}: \annot{\tau}{\varepsilon}~\kw{with} \varepsilon \cup \kwa{effects}(\kwa{annot}(\Gamma, \varepsilon))$.

\textbf{Subcase 2: $x \neq y$}. Because $\Gamma, y: \erase{\hat \tau} \vdash x: \tau$, and $x \neq y$, then $x: \tau \in \Gamma$. Then $x: \annot{\tau}{\varepsilon} \in \annot{\Gamma}{\varepsilon}$, so $\annot{\Gamma}{\varepsilon} \vdash x: \annot{\tau}{\varepsilon}~\kw{with} \varnothing$ by \textsc{$\varepsilon$-Var}. By definition, $\annot{x}{\varepsilon} = x$, so $\annot{\Gamma}{\varepsilon} \vdash \annot{x}{\varepsilon}: \annot{\tau}{\varepsilon}~\kw{with} \varnothing$. Applying \textsc{$\varepsilon$-Subsume} gives $\annot{\Gamma}{\varepsilon} \vdash \annot{x}{\varepsilon}: \annot{\tau}{\varepsilon}~\kw{with} \varepsilon~\cup~\kw{effects}(\kwa{annot}(\Gamma, \varepsilon))$. Lastly, by widening the context, $\hat \Gamma, \annot{\Gamma}{\varepsilon}, y: \hat \tau \vdash \annot{\tau}{\varepsilon}~\kw{with} \varepsilon~\cup~\kw{effects}(\kwa{annot}(\Gamma, \varepsilon))$.\\

\textit{Case: \textsc{T-Resource}}. Then $\Gamma, y: \kwa{erase}(\hat \tau) \vdash r : \{ r \}$. By definition, $\kwa{annot}(r, \varepsilon) = r$ and $\kwa{annot}(\{ r \}, \varepsilon$). By \textsc{$\varepsilon$-Resource}  $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon), y: \hat \tau \vdash r: \{ r \}~\kw{with} \varnothing$. By \textsc{$\varepsilon$-Subsume}, $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon), y: \hat \tau \vdash r: \{ r \}~\kw{with} \varepsilon \cup \kwa{effects}(\kwa{annot}(\Gamma, \varepsilon))$.\\

\textit{Case: \textsc{T-Abs}}. Then $\Gamma, y: \erase{\hat \tau} \vdash \lambda x: \tau_1.e_{body}: \tau_1 \rightarrow \tau_2$. Applying definitions, $\kwa{annot}(e, \varepsilon') = \kwa{annot}(\lambda x: \tau_1.e_2, \varepsilon') = \lambda x: \annot{\tau_1}{\varepsilon'}.\annot{e_2}{\varepsilon'}$ and $\annot{\tau}{\varepsilon'} = \annot{\tau_1 \rightarrow \tau_2}{\varepsilon'} = \kwa{annot}(\tau_1, \varepsilon') \rightarrow_{\varepsilon'} \kwa{annot}(\tau_2, \varepsilon')$. By inversion on \textsc{T-Abs}, we get the sub-derivation $\Gamma, y: \erase{\hat \tau}, x: \tau_1 \vdash e_{body}: \tau_2$. We shall apply the inductive assumption to this judgement with an unlabelled context $\Gamma, x: \tau_1$. Define $\varepsilon'' = \varepsilon' \cup \fx{\annot{\tau_1}{\varepsilon}}$. $\varepsilon''$ is the inductive assumption's version of $\varepsilon'$. Applying the inductive assumption, $\hat \Gamma, \annot{\Gamma}{\varepsilon''}, y: \hat \tau, x: \annot{\tau_1}{\varepsilon''} \vdash \annot{e_{body}}{\varepsilon''}: \annot{\tau_2}{\varepsilon''}~\kw{with} \varepsilon''$.

Ostensibly, $\varepsilon''$ seems to differ from $\varepsilon'$ by $\fx{\annot{\tau_1}{\varepsilon'}}$, but we shall show $\varepsilon' = \varepsilon''$. By assumption (3), $\varepsilon' = \fx{\hat \tau} \cup \hofx{\annot{\tau}{\varepsilon}}$. In this case, $\tau = \tau_1 \rightarrow \tau_2$, so $\annot{\tau}{\varepsilon} = \annot{\tau_1}{\varepsilon} \rightarrow_{\varepsilon} \annot{\tau_2}{\varepsilon}$. By definition, $\fx{\annot{\tau_1}{\varepsilon}} \subseteq \hofx{\annot{\tau}{\varepsilon}}$, so $\fx{\annot{\tau_1}{\varepsilon}} \subseteq \varepsilon$. Therefore, $\varepsilon'' = \varepsilon~\cup~ \fx{\annot{\Gamma}{\varepsilon}}$. But this is the definition of $\varepsilon'$, so $\varepsilon'' = \varepsilon'$.

We can therefore rewrite the judgement obtained from the inductive hypothesis as $\hat \Gamma, \annot{\Gamma}{\varepsilon'}, y: \hat \tau, x: \annot{\tau_1}{\varepsilon'} \vdash \annot{e_{body}}{\varepsilon'}: \annot{\tau_2}{\varepsilon'}~\kw{with} \varepsilon'$. Applying \textsc{$\varepsilon$-Abs}, $\hat \Gamma, \annot{\Gamma}{\varepsilon'}, y: \hat \tau \vdash \lambda x: \annot{\tau_1}{\varepsilon'}. \annot{e_{body}}{\varepsilon'}~\kw{with} \varnothing$. Lastly, by \textsc{$\varepsilon$-Subsume}, $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon), y: \hat \tau \vdash \kwa{annot}(e, \varepsilon) : \kwa{annot}(\hat \tau_1) \rightarrow_{\varepsilon} \kwa{annot}(\hat \tau_2)~\kw{with} \varepsilon \cup \kwa{effects}(\kwa{annot}(\Gamma), \varepsilon)$.\\

\textit{Case: \textsc{T-App}} Then $\Gamma, y: \kwa{erase}(\hat \tau) \vdash e_1~e_2: \tau_3$, where $\Gamma, y:\kwa{erase}(\hat \tau) \vdash e_1: \tau_2 \rightarrow \tau_3$ and $\Gamma, y: \kwa{erase}(\hat \tau) \vdash e_2: \tau_2$. By applying the inductive assumption to $e_1$ and $e_2$, we get $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon), y: \hat \tau \vdash \kwa{annot}(e_1, \varepsilon): \kwa{annot}(\tau_1, \varepsilon)~\kw{with} \varepsilon$ and $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon), y: \hat \tau \vdash \kwa{annot}(e_2, \varepsilon): \kwa{annot}(\tau_2, \varepsilon)~\kw{with} \varepsilon$. Simplifying, $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon), y: \hat \tau \vdash \kwa{annot}(e_1, \varepsilon): \kwa{annot}(\tau_2, \varepsilon) \rightarrow_{\varepsilon} \kwa{annot}(\tau_3, \varepsilon)~\kw{with} \varepsilon$. Then by \textsc{$\varepsilon$-App}, we get $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon), y: \hat \tau \vdash \kwa{annot}(e_1~e_2, \varepsilon):  \kwa{annot}(\tau_3, \varepsilon)~\kw{with} \varepsilon$.
\\

\noindent
\textit{Case: \textsc{T-OperCall}} Then $\Gamma, y: \kwa{erase}(\hat \tau) \vdash e_1.\pi : \Unit$. By inversion we get the sub-derivation $\Gamma, y: \kwa{erase}(\hat \tau) \vdash e_1: \{ \bar r \}$. By definition, $\kwa{annot}(\{ \bar r \}, \varepsilon) = \{ \bar r \}$. By inductive assumption, $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon), y: \hat \tau \vdash e_1: \{ \bar r \} ~\kw{with} \varepsilon \cup \kwa{effects}(\kwa{annot}(\Gamma, \varepsilon))$. By \textsc{$\varepsilon$-OperCall}, $\hat \Gamma, \kwa{annot}(\Gamma, \varepsilon), y: \hat \tau \vdash e_1.\pi: \{ \bar r \} ~\kw{with} \varepsilon \cup \{ \bar r.\pi \}$. \\

It remains to show $\{ \bar r.\pi \} \subseteq \varepsilon$. We shall do this by considering where $r$ must have come from (which subcontext left of the turnstile).  \\

\textbf{Subcase 1.} $r = \hat \tau$. As $\varepsilon = \kwa{effects}(\hat \tau)$, then $r.\pi \in \kwa{effects}(\hat \tau)$. \\

\textbf{Subcase 2.} $r: \{ r \} \in \Gamma$. As $\kwa{annot}(r, \varepsilon) = r$, then $r.\pi \in \kwa{annot}(\Gamma, \varepsilon)$. \\

\textbf{Subcase 3.} $r: \{ r \} \in \hat \Gamma$. Then because $\Gamma, y: \kwa{erase}(\hat \tau) \vdash e_1: \{ \bar r \}$, then $r \in \Gamma$ or $r = \kwa{erase}(\hat \tau) = \hat \tau$ and one of the above subcases must also hold. \\

\end{proof}

\hrulefill

\begin{theorem}[Preservation]
If $\hat \Gamma \vdash \hat e_A: \hat \tau_A~\kw{with} \varepsilon_A$ and $e_A \longrightarrow e_B~|~\varepsilon_C$, then $\hat \Gamma \vdash e_B: \tau_B~\kw{with} \varepsilon_B$, where $e_B <: e_A$ and $\varepsilon \cup \varepsilon_B \subseteq \varepsilon_A$.
\end{theorem}

\begin{proof}
By induction on $\hat \Gamma \vdash \hat e_A: \hat \tau_A~\kw{with} \varepsilon_A$, and then on $e_A \longrightarrow e_B~|~\varepsilon$. \\

\textit{Case:} \textsc{$\varepsilon$-Module}
Then $e_A = \import{\varepsilon}{x}{\hat e}{e}$.

\textbf{Subcase:} \textsc{E-Module1} If the reduction rule used was \textsc{E-ModuleCall1} then the result follows by applying the inductive hypothesis to $\hat e$.

\textbf{Subcase:} \textsc{E-Module2} Otherwise $\hat e$ is a value and the reduction used was \textsc{E-ModuleCall2}. The following are true:
\begin{enumerate}
	\setlength\itemsep{-0.7em}
	\item $e_A = \kwa{import}(\varepsilon)~x = \hat v~\kw{in} e$
	\item $\hat \Gamma \vdash e_A: \kwa{annot}(\tau, \varepsilon)~\kw{with} \varepsilon \cup \varepsilon_1$
	\item $\kwa{import}(\varepsilon)~x = \hat v~\kw{in} e \longrightarrow [\hat v/x]\kwa{annot}(e, \varepsilon)~|~\varnothing$
	\item $\hat \Gamma \vdash \hat v: \hat \tau~\kw{with} \varnothing$
	\item $\varepsilon = \kwa{effects}(\hat \tau)$
	\item $\kwa{ho \hyphen safe}(\hat \tau, \varepsilon)$
	\item $x: \kwa{erase}(\hat \tau) \vdash e: \tau$
\end{enumerate}

Apply the annotation lemma with $\Gamma = \varnothing$ to get $\hat \Gamma, x: \hat \tau \vdash \kwa{annot}(e, \varepsilon): \kwa{annot}(\tau, \varepsilon)~\kw{with} \varepsilon$. From \textbf{4.} we have $\hat \Gamma \vdash \hat v: \hat \tau~\kw{with} \varnothing$, so we can apply the substitution lemma, giving $\hat \Gamma \vdash [\hat v/x]\kwa{annot}(e, \varepsilon): \kwa{annot}(\tau, \varepsilon)~\kw{with} \varepsilon$. By canonical forms, $\varepsilon_1 = \varepsilon_C = \varnothing$. Then $\varepsilon_B = \varepsilon = \varepsilon_A \cup \varepsilon_C$. By examination, $\tau_A = \tau_B = \kwa{annot}(\tau, \varepsilon)$.

\end{proof}

\hrulefill

\begin{theorem}[Soundness]
If $\hat \Gamma \vdash \hat e_A: \hat \tau_A~\kw{with} \varepsilon_A$ and $\hat e_A$ is not a value, then $e_A \longrightarrow e_B~|~\varepsilon$, where $\hat \Gamma \vdash e_B: \hat \tau_B~\kw{with} \varepsilon_B$ and $\hat \tau_B <: \hat \tau_A$ and $\varepsilon_B \cup \varepsilon \subseteq \varepsilon_A$.
\end{theorem}


\begin{theorem}[Multi-step Soundness]
If $\hat \Gamma \vdash \hat e_A: \hat \tau_A~\kw{with} \varepsilon_A$ and $\hat e_A \longrightarrow^{*} e_B~|~\varepsilon$, where $\hat \Gamma \vdash e_B: \hat \tau_B~\kw{with} \varepsilon_B$ and $\hat \tau_B <: \hat \tau_A$ and $\varepsilon_B \cup \varepsilon \subseteq \varepsilon_A$.
\end{theorem}


\begin{proof}
The proofs are the same as for $\opercalc$.
\end{proof}

\end{appendix}
